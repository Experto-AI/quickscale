#!/usr/bin/env bash
# Lint the entire project: Python (ruff + mypy) and React frontend (ESLint + TypeScript)
# Usage: ./scripts/lint.sh
#
# Run Python only:  ./scripts/lint.sh --python
# Run React only:   ./scripts/lint.sh --frontend

set -e

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"
EXIT_CODE=0

# Parse arguments
RUN_PYTHON=true
RUN_FRONTEND=true

if [ "${1:-}" = "--python" ]; then
	RUN_FRONTEND=false
elif [ "${1:-}" = "--frontend" ]; then
	RUN_PYTHON=false
fi

echo "ğŸ” Running project-wide lint checks..."
echo ""

# â”€â”€â”€ Python Linting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ "$RUN_PYTHON" = true ]; then
	echo "ğŸ Python lint checks..."
	echo ""

	echo "  â†’ Running ruff check..."
	if poetry run ruff check --fix .; then
		echo "  âœ… ruff check passed"
	else
		echo "  âŒ ruff check found issues"
		EXIT_CODE=1
	fi

	echo "  â†’ Running ruff format..."
	if poetry run ruff format .; then
		echo "  âœ… ruff format passed"
	else
		echo "  âŒ ruff format found issues"
		EXIT_CODE=1
	fi

	echo "  â†’ Running mypy..."
	if poetry run mypy {{ package_name }}/; then
		echo "  âœ… mypy passed"
	else
		echo "  âŒ mypy found type errors"
		EXIT_CODE=1
	fi
	echo ""
fi

# â”€â”€â”€ React Frontend Linting â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ "$RUN_FRONTEND" = true ] && [ -d "$ROOT/frontend" ]; then
	echo "âš›ï¸  React frontend lint checks..."
	echo ""

	cd "$ROOT/frontend"

	if ! command -v pnpm &> /dev/null; then
		echo "  âŒ pnpm is required but not installed."
		echo "  ğŸ’¡ Install pnpm: npm install -g pnpm"
		EXIT_CODE=1
		cd "$ROOT"
	else
		# Check if node_modules exists
		if [ ! -d "node_modules" ]; then
			echo "  â†’ Installing frontend dependencies..."
			pnpm install
		fi

		echo "  â†’ Running ESLint..."
		if pnpm lint; then
			echo "  âœ… ESLint passed"
		else
			echo "  âŒ ESLint found issues"
			EXIT_CODE=1
		fi

		echo "  â†’ Running TypeScript type check..."
		if pnpm type-check; then
			echo "  âœ… TypeScript check passed"
		else
			echo "  âŒ TypeScript found type errors"
			EXIT_CODE=1
		fi

		cd "$ROOT"
	fi

	echo ""
elif [ "$RUN_FRONTEND" = true ]; then
	echo "â„¹ï¸  No frontend/ directory found, skipping React lint"
	echo ""
fi

# â”€â”€â”€ Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

if [ $EXIT_CODE -eq 0 ]; then
	echo "âœ… All lint checks passed!"
else
	echo "âŒ Some lint checks failed!"
	exit $EXIT_CODE
fi
