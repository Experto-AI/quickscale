name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests (Unit + Integration)
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.12"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Poetry
      id: install-poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
      # Retry on SSL/network failures
      continue-on-error: true

    - name: Retry Poetry install (if failed)
      if: steps.install-poetry.outcome == 'failure'
      run: |
        for i in {1..3}; do
          curl -sSL https://install.python-poetry.org | python3 - && break || sleep 5
        done
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pypoetry
          .venv
        key: ${{ runner.os }}-poetry-${{ hashFiles('poetry.lock') }}
        restore-keys: |
          ${{ runner.os }}-poetry-

    - name: Install dependencies
      run: |
        poetry install --with dev

    - name: Run linting (ruff)
      run: |
        poetry run ruff check quickscale_core quickscale_cli quickscale_modules
        echo "Running ruff format..."
        poetry run ruff format quickscale_core quickscale_cli quickscale_modules
        echo "Checking format..."
        poetry run ruff format --check quickscale_core quickscale_cli quickscale_modules

    - name: Run type checking (mypy)
      run: |
        poetry run mypy quickscale_core/src/
        poetry run mypy quickscale_cli/src/
        # Type check modules (each module may have its own stubs config)
        for mod in quickscale_modules/*/; do
          if [ -d "${mod}src" ]; then
            echo "Type checking ${mod}..."
            poetry run mypy "${mod}src/" || true
          fi
        done

    - name: Run tests (quickscale_core) - Unit & Integration only
      run: |
        poetry run pytest quickscale_core -m "not e2e" --cov=quickscale_core --cov-report=xml --cov-report=term

    - name: Run tests (quickscale_cli)
      run: |
        poetry run pytest quickscale_cli --cov=quickscale_cli --cov-report=xml --cov-report=term

    - name: Run tests (quickscale_modules)
      run: |
        # Test modules using centralized dependencies
        # PYTHONPATH set to module dir so tests.settings is importable
        for mod in quickscale_modules/*/; do
          if [ -d "${mod}tests" ]; then
            mod_name=$(basename "$mod")
            pkg_name="quickscale_modules_${mod_name}"
            echo "Testing module: $mod_name"
            PYTHONPATH="${mod}:${mod}src" poetry run pytest "${mod}tests/" \
              --cov="$pkg_name" --cov-report=term \
              -p pytest_django --ds=tests.settings || true
          fi
        done

    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always() && github.ref == 'refs/heads/main'
      with:
        files: ./quickscale_core/coverage.xml,./quickscale_cli/coverage.xml
        flags: unittests,integration
        name: codecov-umbrella
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
      continue-on-error: true

  lint-cli:
    name: Lint CLI Package
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: "3.12"

    - name: Install Poetry
      id: install-poetry-cli
      uses: snok/install-poetry@v1
      # Retry on SSL/network failures
      continue-on-error: true

    - name: Retry Poetry install (if failed)
      if: steps.install-poetry-cli.outcome == 'failure'
      run: |
        for i in {1..3}; do
          curl -sSL https://install.python-poetry.org | python3 - && break || sleep 5
        done
        echo "$HOME/.local/bin" >> $GITHUB_PATH

    - name: Install dependencies
      run: poetry install --with dev

    - name: Run linting
      run: |
        poetry run ruff check quickscale_cli
        echo "Running ruff format on quickscale_cli..."
        poetry run ruff format quickscale_cli
        echo "Checking format..."
        poetry run ruff format --check quickscale_cli

    - name: Run type checking
      run: |
        poetry run mypy quickscale_cli/src/
